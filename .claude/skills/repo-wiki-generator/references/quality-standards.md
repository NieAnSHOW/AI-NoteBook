# 质量保障体系

## 验证机制

### 自动验证

使用脚本验证文档质量和一致性：
```bash
python scripts/validate_document.py <document_path>
```

**验证维度**:
1. **来源标注完整性**
   - 所有类/模块、函数/方法、接口都有文件路径和行号
   - 格式正确：`ComponentName.methodName()` (file/path:line_number)

2. **预估行数标注**
   - 所有章节标题下都有预估行数
   - 格式正确：`## 章节标题 (预估约 X 行)`

3. **使用示例完整性**
   - 所有功能描述都有使用场景示例
   - 示例包含：场景描述、代码示例、预期结果

4. **流程图清晰度**
   - 所有流程图使用 Mermaid 格式
   - 流程图节点有详细说明
   - 流程图与代码逻辑一致

5. **内容一致性**
   - 所有技术信息与实际代码100%一致
   - 无推测或臆造内容
   - 无模糊词汇（可能、应该、大概）

### 手动检查清单

#### 维度1: 架构完整性

- [ ] Application 层节点与 Domain 层 Task 对应
- [ ] 资源引用内嵌在步骤中
- [ ] 所有文档按照模板结构生成

#### 维度2: 确定性逻辑分离

- [ ] 计算逻辑已抽取为脚本
- [ ] 脚本已测试通过
- [ ] 指令仅包含需要 Agent 思考的内容

#### 维度3: 内容质量

- [ ] 无辅助文档（README.md 等）
- [ ] 无信息重复
- [ ] 路径使用正斜杠 `/`
- [ ] 所有内容标注来源

#### 维度4: 性能优化

- [ ] 单个文档控制在合理行数内
- [ ] 超过2000行的模块已拆分
- [ ] 详细文档移到 references/

---

## 质量标准

### 文档质量标准

#### 1. 可追溯性（最高优先级）

**标准**: 所有结论、图表、示例必须标注来源

**验证**:
- [ ] 每个类/模块引用都有文件路径和行号
- [ ] 每个方法/函数引用都有文件路径和行号
- [ ] 每个配置引用都有文件路径和行号
- [ ] 每个流程图节点都有来源标注
- [ ] 每个代码示例都有来源标注

**示例**:
```
✅ 正确：来源：`UserService.createUser()` (src/services/UserService.java:45-60)
❌ 错误：来源：UserService
❌ 错误：无来源标注
```

#### 2. 示例驱动

**标准**: 所有类、方法、接口描述必须补充使用场景示例

**验证**:
- [ ] API/接口层说明有使用示例
- [ ] 服务层方法说明有使用示例
- [ ] 数据访问层方法说明有使用示例
- [ ] 工具函数说明有使用示例
- [ ] 外部集成接口说明有使用示例

**示例结构**:
```markdown
**使用场景**：{场景描述}

```{language}
// 示例代码
{code_snippet}
```

**预期结果**：{结果说明}

来源：`{ComponentName}.{functionName}()` ({file_path}:{line_number})
```

#### 3. 零推测原则

**标准**: 严禁任何形式的推测、臆测或理论化描述

**验证**:
- [ ] 无"可能"、"应该"、"大概"等模糊词汇
- [ ] 无描述不存在的功能
- [ ] 无臆造接口或方法
- [ ] 无推测设计意图
- [ ] 所有内容基于实际代码

**示例**:
```
✅ 正确：该方法用于创建用户（来源：UserService.createUser()）
❌ 错误：该方法可能用于创建用户
❌ 错误：该方法应该用于创建用户
```

#### 4. 内容一致性

**标准**: 内容与源代码100%一致

**验证**:
- [ ] 所有方法签名与代码一致
- [ ] 所有字段定义与代码一致
- [ ] 所有接口参数与代码一致
- [ ] 所有返回值类型与代码一致
- [ ] 所有配置参数与代码一致

#### 5. 结构化组织

**标准**: 按层次逻辑组织内容

**验证**:
- [ ] 接口层、数据层、业务层、依赖层清晰划分
- [ ] 模块划分合理
- [ ] 章节结构清晰
- [ ] 目录结构规范

---

## 验证流程

### 节点验证

每个文档生成后立即验证：

1. **节点4验证** (项目概述)
   - 验证来源标注完整性
   - 验证使用示例完整性
   - 验证预估行数标注
   - 验证内容与代码一致性

2. **节点5验证** (业务模块)
   - 验证流程图清晰度
   - 验证节点详解完整性
   - 验证来源标注完整性
   - 验证使用示例完整性

3. **节点6验证** (项目规范)
   - 验证规范基于代码分析
   - 验证规范标注来源
   - 验证示例来自实际代码

4. **节点7验证** (文件关系)
   - 验证调用链路完整性
   - 验证数据转换说明
   - 验证异常处理说明
   - 验证性能考虑说明

5. **节点8验证** (最终整合)
   - 验证所有文档已生成
   - 验证文档间一致性
   - 验证索引完整性
   - 验证版本信息完整

### 文档间一致性检查

1. **模块划分一致性**
   - 项目概述中的模块列表与业务模块文档一致
   - 模块职责描述一致

2. **接口描述一致性**
   - 项目概述中的接口列表与实际接口文档一致
   - 接口参数描述一致

3. **数据模型一致性**
   - 项目概述中的数据模型与业务模块中的引用一致
   - 字段定义一致

---

## 错误处理

### 验证失败处理

**验证失败时的处理流程**:
1. 记录失败原因和位置
2. 返回对应节点重新生成
3. 修正问题后重新验证
4. 验证通过后继续下一步

### 常见错误类型

#### 1. 来源标注缺失

**错误**: 类/方法/配置引用没有标注来源

**修正**:
- 添加来源标注：`来源：`ComponentName.methodName()` (file/path:line_number)`

#### 2. 使用示例缺失

**错误**: 功能描述没有使用场景示例

**修正**:
- 添加使用场景示例，包含场景描述、代码示例、预期结果

#### 3. 流程图不清晰

**错误**: 流程图节点没有详细说明

**修正**:
- 为每个流程图节点添加详细说明
- 说明子流程、规则逻辑、数据转换、异常处理

#### 4. 内容不一致

**错误**: 技术信息与实际代码不一致

**修正**:
- 重新读取代码
- 更新文档内容
- 确保与代码100%一致

#### 5. 模糊词汇使用

**错误**: 使用"可能"、"应该"、"大概"等模糊词汇

**修正**:
- 使用确定性语言
- 基于实际代码描述
- 不确定时向用户询问

---

## 质量指标

### 定量指标

| 指标 | 目标值 | 测量方法 |
|------|-------|---------|
| 来源标注覆盖率 | 100% | 自动验证 |
| 使用示例覆盖率 | 100% | 自动验证 |
| 内容一致性 | 100% | 自动验证 |
| 流程图清晰度 | 100% | 手动检查 |
| 预估行数准确性 | ±30% | 生成后验证 |

### 定性指标

| 指标 | 评估标准 |
|------|---------|
| 可读性 | 文档结构清晰，易于理解 |
| 可维护性 | 文档结构化，易于更新 |
| 可追溯性 | 所有内容标注来源 |
| 完整性 | 覆盖所有模块，无遗漏 |
| 准确性 | 与代码100%一致 |

---

## 持续改进

### 反馈机制

1. **用户反馈**
   - 收集用户对文档质量的反馈
   - 记录常见问题和改进建议

2. **自动验证**
   - 定期运行验证脚本
   - 记录验证失败情况

3. **代码变更**
   - 代码变更后重新生成文档
   - 对比新旧文档差异

### 改进措施

1. **优化模板**
   - 根据反馈优化文档模板
   - 改进文档结构

2. **增强验证**
   - 扩展验证规则
   - 提高验证准确性

3. **改进流程**
   - 优化生成流程
   - 提高生成效率

---

## 来源追溯

本质量保障体系基于以下原则和规范：

- 可追溯性原则：`references/core-principles.md`
- 文档模板：`references/document-templates.md`
- TOT执行架构：`references/tot-architecture.md`