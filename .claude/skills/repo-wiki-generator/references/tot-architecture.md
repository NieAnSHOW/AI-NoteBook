# Tree of Thoughts 执行架构

## 完整执行链路

```
用户输入生成命令
  ↓
节点1: 环境检查
  ↓ (工作目录干净?)
  ├─ 是 → 节点2: 项目扫描
  └─ 否 → 警告 → 用户选择 → 继续/取消
  ↓
节点3: 文档规划
  ↓ (用户确认?)
  ├─ 确认 → 节点4: 项目概述
  └─ 修改/取消 → 重新规划/终止
  ↓
节点4: 生成项目概述
  ↓ (验证通过?)
  ├─ 是 → 节点5: 业务模块
  └─ 否 → 重新生成
  ↓
节点5: 生成业务模块文档
  ↓ (验证通过? 还有模块?)
  ├─ 是 → 继续下一模块
  └─ 否 → 节点6: 项目规范
  ↓
节点6: 生成项目规范
  ↓ (验证通过?)
  ├─ 是 → 节点7: 文件关系分析
  └─ 否 → 重新生成
  ↓
节点7: 文件关系分析
  ↓ (验证通过?)
  ├─ 是 → 节点8: 最终整合
  └─ 否 → 重新分析
  ↓
节点8: 最终整合
  ↓ (验证通过?)
  ├─ 是 → 完成
  └─ 否 → 修正对应文档
```

## 节点定义

### 节点1: 环境检查

**目的**: 验证工作目录状态和输出目录

**执行步骤**:
1. 检查 Git 工作目录状态（可选警告）
2. 记录当前 commit（如果在 Git 仓库中）
3. 检查并创建 `gientech/wiki/` 输出目录

**允许操作**:
- 执行 Git 查询命令
- 创建输出目录
- 记录环境信息

**禁止操作**:
- 修改代码文件
- 执行 Git 提交或切换分支
- 强制要求特定分支

**下一步**: 节点2: 项目结构扫描

---

### 节点2: 项目结构扫描

**目的**: 全面扫描项目结构，识别模块、分层和组件

**执行步骤**:

1. **识别构建系统**
   - Java: `pom.xml`, `build.gradle`, `build.gradle.kts`
   - Python: `requirements.txt`, `setup.py`, `pyproject.toml`
   - JavaScript: `package.json`, `yarn.lock`
   - Go: `go.mod`, `go.sum`
   - Rust: `Cargo.toml`, `Cargo.lock`
   - C#: `*.csproj`, `*.sln`
   - Ruby: `Gemfile`
   - PHP: `composer.json`

2. **扫描目录结构**
   - 源码目录: `src/`, `lib/`, `app/`, `pkg/`
   - 测试目录: `test/`, `tests/`, `__tests__/`
   - 配置目录: `config/`, `conf/`, `settings/`
   - 文档目录: `docs/`, `doc/`

3. **扫描接口层**
   - Java: `*Controller.java`, `*Api.java`, `*Endpoint.java`
   - Python: `*view.py`, `*api.py`, `*router.py`
   - JavaScript: `*controller.js`, `*route.js`, `*api.js`
   - Go: `*handler.go`, `*controller.go`, `*api.go`
   - Rust: `*handler.rs`, `*controller.rs`
   - C#: `*Controller.cs`, `*Api.cs`

4. **扫描数据层**
   - Java: `*Entity.java`, `*Repository.java`, `*Mapper.java`
   - Python: `*model.py`, `*repository.py`, `*dao.py`
   - JavaScript: `*model.js`, `*repository.js`, `*schema.js`
   - Go: `*model.go`, `*repository.go`
   - Rust: `*model.rs`, `*repository.rs`
   - C#: `*Entity.cs`, `*Repository.cs`

5. **扫描业务层**
   - Java: `*Service.java`, `*Manager.java`, `*Handler.java`
   - Python: `*service.py`, `*manager.py`, `*handler.py`
   - JavaScript: `*service.js`, `*manager.js`
   - Go: `*service.go`, `*manager.go`
   - Rust: `*service.rs`, `*manager.rs`
   - C#: `*Service.cs`, `*Manager.cs`

6. **扫描适配器层**
   - Java: `*Client.java`, `*Adapter.java`, `*Facade.java`
   - Python: `*client.py`, `*adapter.py`, `*facade.py`
   - JavaScript: `*client.js`, `*adapter.js`
   - Go: `*client.go`, `*adapter.go`
   - Rust: `*client.rs`, `*adapter.rs`
   - C#: `*Client.cs`, `*Adapter.cs`

7. **扫描中间件依赖**
   - 配置文件: `*.yml`, `*.yaml`, `*.json`, `*.toml`, `.env`
   - Java: `application*.yml`, `application*.properties`
   - Python: `settings.py`, `config.py`
   - JavaScript: `.env`, `config.js`
   - Go: `config.yaml`, `config.toml`

8. **分析服务定位**
   - 从项目名称和配置推断服务定位
   - 从接口层分析服务使用场景
   - 从业务层推断核心职责
   - 从目录结构理解职责边界

**下一步**: 节点3: 生成文档规划

---

### 节点3: 文档规划

**目的**: 基于扫描结果，生成完整文档规划

**执行步骤**:

1. **概述规划**
   - 项目介绍和核心价值
   - 对外接口能力清单
   - 数据模型和仓储层
   - 业务/领域模块划分
   - 防腐层/适配器依赖
   - 中间件依赖和使用
   - 预估每个章节行数

2. **模块规划**
   - 识别需要详细文档的业务模块
   - 评估每个模块复杂度
   - 单模块>2000行时拆分：
     - 模块概述
     - 核心流程详解
     - 规则逻辑详解

3. **规范规划**
   - 规划项目规范文档
   - 基于项目实际编程语言规范
   - 预估文档行数

4. **关系链路规划**
   - 识别需要分析的关键调用链路
   - 分类：
     - 核心业务流程链路（2-5个）
     - 外部系统集成链路
     - 数据流动分析链路（1-3个）
   - 评估复杂度：
     - 简单：单链路<5个文件，<500行
     - 中等：单链路5-10个文件，500-1000行
     - 复杂：单链路>10个文件，>1000行

**文档清单**:
- `gientech/wiki/00-项目概述.md`
- `gientech/wiki/01-业务模块-{模块名}.md`
- `gientech/wiki/99-项目规范.md`
- `gientech/wiki/02-文件关系-核心业务链路.md`
- `gientech/wiki/02-文件关系-外部集成链路.md`
- `gientech/wiki/02-文件关系-数据流动分析.md`

**MANDATORY**: 必须等待用户确认规划后才能继续

**下一步**: 用户确认 → 节点4: 生成项目概述

---

### 节点4: 生成项目概述

**目的**: 生成项目概述文档 (00-项目概述.md)

**执行步骤**:

1. **项目介绍**
   - 分析 README.md 和配置文件
   - 提取项目介绍、核心价值、解决的问题
   - 标注来源文件路径

2. **服务定位**
   - 分析服务定位和使用场景
   - 使用场景：什么业务场景需要调用该服务
   - 职责边界：该服务应该实现哪些业务逻辑
   - 标注推断依据的文件路径和行号

3. **对外接口**
   - 扫描所有对外接口和 API 文件
   - 接口路径/端点
   - 接口功能描述
   - 请求参数
   - 响应格式
   - 使用场景示例
   - 标注每个接口的文件路径和行号

4. **数据模型**
   - 扫描数据模型和数据访问层
   - 数据模型定义和字段说明
   - 数据关系（一对一、一对多、多对多）
   - ER图（Mermaid格式）
   - Repository/DAO 接口
   - 每个方法的功能说明
   - 使用场景示例
   - 标注每个模型和接口的文件路径和行号

5. **业务模块**
   - 扫描业务逻辑和服务层
   - 模块列表
   - 每个模块的核心组件
   - 组件的职责说明
   - 组件的主要方法和功能
   - 使用场景示例
   - 标注每个组件和方法的文件路径和行号

6. **适配器层**
   - 扫描适配器层和外部集成
   - 依赖的外部服务列表
   - 每个服务的功能说明
   - 依赖的接口清单
   - 接口功能和参数说明
   - 使用场景示例
   - 标注每个适配器的文件路径和行号

7. **中间件**
   - 扫描配置文件和中间件集成
   - Redis/MQ/ES等中间件列表
   - 每个中间件的用途说明
   - 调用接口的方法清单
   - 每个方法的功能说明
   - 使用场景示例
   - 标注配置和集成代码的文件路径和行号

8. **行数标注**
   - 在每个章节标题下标注预估行数
   - 格式：`## 章节标题 (预估约 X 行)`

**质量要求**:
- 所有类/模块、函数/方法、接口必须标注文件路径和行号
- 所有功能描述必须补充使用场景示例
- 所有预估行数必须在章节标题下标注
- 内容必须与实际代码100%一致
- 严禁推测或臆造任何信息

**下一步**: 验证 → 节点5: 业务模块

---

### 节点5: 生成业务模块文档

**目的**: 按模块生成详细的业务逻辑文档

**执行步骤**:

1. **模块迭代**
   - 遍历所有业务模块
   - 基于节点2识别的业务模块列表

2. **复杂度检查**
   - 评估当前模块的复杂度
   - 预估文档行数是否超过2000行
   - 如果>2000行，拆分为多个子文档

3. **核心流程图**
   - 用流程图讲清楚主干的核心逻辑
   - 格式：Mermaid flowchart
   - 先展示整体流程，再对每个节点展开介绍

4. **节点详解**
   - 对流程图中每个节点做打开和介绍
   - 子流程描述
   - 规则逻辑说明
   - 数据转换逻辑
   - 异常处理机制
   - 标注每个逻辑的文件路径和行号

5. **使用示例**
   - 补充使用场景示例
   - 每个主要功能都要有实际使用示例

**文档结构**:
- 单模块：`gientech/wiki/01-业务模块-{模块名}.md`
- 复杂模块拆分：
  - `gientech/wiki/01-业务模块-{模块名}-概述.md`
  - `gientech/wiki/01-业务模块-{模块名}-核心流程.md`
  - `gientech/wiki/01-业务模块-{模块名}-规则逻辑.md`

**质量要求**:
- 流程图必须清晰展示主干逻辑
- 所有节点都要有详细说明
- 所有代码逻辑必须标注来源
- 必须补充使用场景示例

**下一步**: 验证 → 下一模块 → 节点6: 项目规范

---

### 节点6: 生成项目规范

**目的**: 生成项目编码规范文档 (99-项目规范.md)

**执行步骤**:

1. **识别编程语言**
   - 分析项目文件扩展名分布
   - 识别主要编程语言
   - 统计各语言文件数量和代码行数

2. **分析现有代码**
   - 命名规范：类/模块、方法/函数、变量、常量、文件命名
   - 代码结构：目录组织、模块划分、分层架构、包/命名空间
   - 注释风格：类/模块级、方法/函数级、行内注释、文档字符串
   - 错误处理：异常类型、捕获模式、错误返回、日志记录
   - 测试规范：测试文件组织、命名规范、框架使用、Mock/Stub

3. **提取配置规范**
   - 代码检查工具配置（linter）
   - 代码格式化配置
   - 项目配置文件（README, CONTRIBUTING等）

4. **推断设计原则**
   - 识别架构模式（分层架构、DDD、微服务、事件驱动）
   - 识别设计模式（工厂、单例、策略、观察者、依赖注入）
   - 评估SOLID原则遵循情况

5. **聚合规范**
   - 编码规范（基于代码分析）
   - 设计原则（基于架构分析）
   - 最佳实践（基于项目实践）
   - 项目特有约定（基于配置和代码）
   - 代码审查清单（基于规范总结）

**质量要求**:
- 规范必须100%基于实际项目代码分析
- 所有规范必须标注分析来源和依据
- 包含从项目代码提取的具体示例
- 识别并标注项目中的不一致之处
- 严禁推测或使用通用模板

**下一步**: 节点7: 文件关系分析

---

### 节点7: 文件关系分析

**目的**: 分析文件间的联动关系、依赖链路和数据流动

**执行步骤**:

1. **依赖扫描**
   - import/include 语句分析
   - 类继承和接口实现关系
   - 方法调用链路追踪
   - 配置文件引用关系

2. **调用链分析**
   - Controller → Service → Repository 调用链
   - Service → Adapter → External Service 调用链
   - 业务流程中的跨模块调用
   - 事件驱动的异步调用链
   - 从入口点开始追踪
   - 识别每个调用节点的文件位置
   - 标注调用参数和返回值
   - 识别异常处理和错误传播路径

3. **数据流分析**
   - 请求数据的转换流程（DTO → Entity → DO）
   - 响应数据的组装流程（DO → Entity → VO）
   - 数据验证和转换的位置
   - 数据持久化和缓存的流程
   - 使用序列图展示数据流动

4. **模块交互分析**
   - 同步调用
   - 异步消息
   - 事件发布订阅
   - 共享数据访问
   - 交互的触发条件
   - 交互的数据格式
   - 交互的异常处理
   - 交互的性能考虑

5. **关系分类**
   - 核心业务流程的关键调用链（高优先级）
   - 与外部系统的集成链路（高优先级）
   - 数据转换和流动路径（中优先级）
   - 工具类和辅助功能调用（低优先级）

**文档结构**:
- `gientech/wiki/02-文件关系-核心业务链路.md`
- `gientech/wiki/02-文件关系-外部集成链路.md`
- `gientech/wiki/02-文件关系-数据流动分析.md`

**质量要求**:
- 所有调用链路必须标注完整的文件路径和行号
- 所有数据转换必须说明转换规则和位置
- 所有异常处理必须标注处理位置和策略
- 关键链路必须包含性能考虑和优化建议
- 所有图表必须清晰展示文件间的关系
- 必须识别和标注循环依赖和潜在问题

**下一步**: 验证 → 节点8: 最终整合

---

### 节点8: 最终整合

**目的**: 验证所有文档质量和一致性，生成索引文档

**执行步骤**:

1. **文档验证**
   - 所有来源标注是否完整（文件路径+行号）
   - 所有预估行数是否标注
   - 所有功能描述是否有使用示例
   - 流程图是否清晰
   - 内容是否与代码一致

2. **文档一致性检查**
   - 模块划分是否一致
   - 接口描述是否一致
   - 数据模型描述是否一致

3. **生成索引**
   - 生成知识库索引文档
   - 文件名：`gientech/wiki/README.md`
   - 知识库目录
   - 每个文档的简介
   - 文档间的关联关系
   - 版本信息（git commit）

4. **版本追踪**
   - 生成时间
   - 基于的git commit
   - 操作人员（git config user.email）
   - 文档清单

**质量验证**:
- ✅ 所有文档都已生成
- ✅ 所有来源标注完整
- ✅ 所有功能有使用示例
- ✅ 所有流程图清晰可读
- ✅ 内容与代码100%一致

**下一步**: 完成